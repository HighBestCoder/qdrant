# Qdrant + VDE Integration

VDE (Vector Data Engine) å·²æˆåŠŸé›†æˆåˆ° Qdrant ä¸­ï¼Œæä¾›åŸºäº VSAG HNSW + Btrieve2 çš„é«˜æ€§èƒ½å‘é‡å­˜å‚¨å’Œæ£€ç´¢ã€‚

## æ„å»ºçŠ¶æ€

âœ… **ç¼–è¯‘æˆåŠŸ** - æ‰€æœ‰ VDE æ¨¡å—å·²é›†æˆå¹¶é€šè¿‡ç¼–è¯‘
âœ… **è¿è¡Œæ—¶å¯ç”¨** - Qdrant å¯ä»¥æ­£ç¡®åŠ è½½ VDE ç›¸å…³åº“

## å¿«é€Ÿå¼€å§‹

### 1. æ„å»º Qdrant with VDE

```bash
cd /src/db/qdrant
cargo build --release
```

### 2. è¿è¡Œ Qdrant

ä½¿ç”¨æä¾›çš„è„šæœ¬æ¥è®¾ç½®æ­£ç¡®çš„åº“è·¯å¾„ï¼š

```bash
./run_qdrant_with_vde.sh ./target/release/qdrant
```

æˆ–è€…è®¾ç½®å¼€å‘æ¨¡å¼ï¼š

```bash
./run_qdrant_with_vde.sh ./target/debug/qdrant --config-path ./config/config.yaml
```

## é›†æˆæ¶æ„

### VDE ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Qdrant Collection API           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VectorIndexEnum / VectorStorageEnum    â”‚
â”‚  PayloadStorageEnum                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ VDEVectorâ”‚  â”‚VDEVector  â”‚  VDEPayload
â”‚  â”‚ Index    â”‚  â”‚Storage    â”‚  Storage   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”˜
        â”‚              â”‚              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚            vde-sys (FFI Layer)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        VDE C++ Library (libvde.a)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ VSAG HNSW    â”‚    â”‚   Btrieve2     â”‚ â”‚
â”‚  â”‚ (Vector Indexâ”‚    â”‚ (KV Storage)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—è¯´æ˜

1. **VDEVectorIndex** (`lib/segment/src/index/vde_index/`)
   - å®ç° `VectorIndex` trait
   - ç®¡ç† VSAG HNSW ç´¢å¼•
   - æä¾›é«˜æ€§èƒ½çš„å‘é‡æœç´¢

2. **VDEVectorStorage** (`lib/segment/src/vector_storage/vde_storage/`)
   - å®ç° `VectorStorage` trait
   - ä½¿ç”¨ Btrieve2 å­˜å‚¨åŸå§‹å‘é‡æ•°æ®
   - ç®¡ç†å‘é‡çš„æ’å…¥ã€åˆ é™¤å’Œè¯»å–

3. **VDEPayloadStorage** (`lib/segment/src/payload_storage/vde_storage/`)
   - å®ç° `PayloadStorage` trait  
   - ä½¿ç”¨ Btrieve2 å­˜å‚¨ payload å…ƒæ•°æ®
   - æ”¯æŒå­—æ®µç´¢å¼•å’Œè¿‡æ»¤

4. **vde-sys** (`lib/vde-sys/`)
   - Rust FFI ç»‘å®šå±‚
   - è‡ªåŠ¨ç”Ÿæˆçš„ C æ¥å£ç»‘å®š
   - å¤„ç†å†…å­˜å®‰å…¨å’Œç±»å‹è½¬æ¢

## ä¾èµ–åº“

### æ„å»ºæ—¶ä¾èµ–

- **VDE C++ Library**: `/src/db/vde/build/lib/libvde.a`
- **VSAG**: `/src/db/vde/build/lib/libvsag.so`
- **Btrieve2**: `/usr/local/actianzen/lib64/libbtrieveCpp.so`

### è¿è¡Œæ—¶ä¾èµ–

è¿è¡Œæ—¶éœ€è¦ä»¥ä¸‹åŠ¨æ€åº“ï¼š

```bash
libvsag.so           # VSAG HNSW å‘é‡ç´¢å¼•
libbtrieveCpp.so     # Btrieve2 C++ API
libbtrieveC.so       # Btrieve2 C API
libstdc++.so.6       # ç³»ç»Ÿ C++ æ ‡å‡†åº“ (>=GLIBCXX_3.4.30)
```

## å·²çŸ¥é™åˆ¶

1. **é‡åŒ–æ”¯æŒ**: VDE ç›®å‰ä¸æ”¯æŒå‘é‡é‡åŒ–
2. **å¤šå‘é‡**: VDE ä¸æ”¯æŒ multi-vector é…ç½®
3. **Raw Scorer**: VDE ä½¿ç”¨åŸç”Ÿæœç´¢ï¼Œä¸æ”¯æŒ Qdrant çš„ raw scorer æ¥å£
4. **libstdc++ å†²çª**: éœ€è¦ä½¿ç”¨ `LD_PRELOAD` å¼ºåˆ¶ç³»ç»Ÿ libstdc++ ä»¥é¿å…ä¸ Actian Zen ç‰ˆæœ¬å†²çª

## é…ç½®ä½¿ç”¨ VDE

è¦åœ¨ Qdrant ä¸­ä½¿ç”¨ VDEï¼Œéœ€è¦ä¿®æ”¹é›†åˆé…ç½®ï¼ˆè¿™éƒ¨åˆ†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼‰ï¼š

```json
{
  "vectors": {
    "size": 128,
    "distance": "Cosine",
    "storage_type": "vde"  // ä½¿ç”¨ VDE å­˜å‚¨
  },
  "hnsw_config": {
    "type": "vde_hnsw",    // ä½¿ç”¨ VDE HNSW ç´¢å¼•
    "m": 16,
    "ef_construct": 100
  }
}
```

## æ€§èƒ½æµ‹è¯•

å¾…å®Œæˆçš„ä»»åŠ¡ï¼š

- [ ] åˆ›å»ºæ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] ä¸åŸç”Ÿ HNSW æ¯”è¾ƒ
- [ ] æµ‹è¯•å¤§è§„æ¨¡æ•°æ®é›†æ€§èƒ½
- [ ] ä¼˜åŒ–é…ç½®å‚æ•°

## æ•…éšœæ’æŸ¥

### åº“åŠ è½½å¤±è´¥

å¦‚æœé‡åˆ° "library not found" é”™è¯¯ï¼š

```bash
# æ£€æŸ¥åº“æ˜¯å¦å­˜åœ¨
ls -la /src/db/vde/build/lib/libvsag.so
ls -la /usr/local/actianzen/lib64/libbtrieveCpp.so

# æ£€æŸ¥åº“ä¾èµ–
ldd /src/db/qdrant/target/debug/qdrant | grep -E "(vsag|btrieve)"
```

### libstdc++ ç‰ˆæœ¬å†²çª

å¦‚æœé‡åˆ° `GLIBCXX_3.4.30 not found` é”™è¯¯ï¼š

```bash
# ç¡®ä¿ä½¿ç”¨å¯åŠ¨è„šæœ¬è¿è¡Œ
./run_qdrant_with_vde.sh ./target/debug/qdrant

# æˆ–æ‰‹åŠ¨è®¾ç½®
export LD_PRELOAD="/usr/lib/x86_64-linux-gnu/libstdc++.so.6"
export LD_LIBRARY_PATH="/src/db/vde/build/lib:/usr/local/actianzen/lib64:$LD_LIBRARY_PATH"
./target/debug/qdrant
```

## å¼€å‘çŠ¶æ€

### âœ… å·²å®Œæˆ

- VDE æ ¸å¿ƒå®ç°ï¼ˆindexã€storageã€payloadï¼‰
- vde-sys FFI ç»‘å®š
- Qdrant ä¸‰å¤§æšä¸¾é›†æˆï¼ˆVectorIndexEnumã€VectorStorageEnumã€PayloadStorageEnumï¼‰
- ç¼–è¯‘ç³»ç»Ÿé…ç½®
- è¿è¡Œæ—¶åº“åŠ è½½

### ğŸ”„ è¿›è¡Œä¸­

- é…ç½®é€‰é¡¹é›†æˆ
- REST API æ”¯æŒ
- æ€§èƒ½æµ‹è¯•æ¡†æ¶

### ğŸ“‹ å¾…å®Œæˆ

- ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
- ç›‘æ§å’ŒæŒ‡æ ‡
- æ–‡æ¡£å®Œå–„
- ç¤ºä¾‹åº”ç”¨

## è´¡çŒ®

é›†æˆç”± HighBestCoder å®Œæˆï¼ŒåŸºäºï¼š
- Qdrant v1.15.5
- VDE (Vector Data Engine)
- VSAG HNSW
- Actian Zen (Btrieve2)

## è®¸å¯è¯

éµå¾ª Qdrant çš„è®¸å¯è¯
